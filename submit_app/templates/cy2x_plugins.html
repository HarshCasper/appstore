{% extends "base.html" %}
{% load static %}

{% block title %}- 2.x Plugins Management{% endblock %}

{% block more_head %}
<script type="text/javascript" src="{% get_static_prefix %}common/js/setup_ajax_for_csrf.js"></script>
<script type="text/javascript" src="{% get_static_prefix %}common/js/msgs.js"></script>
<script type="text/javascript" src="{% get_static_prefix %}common/lib/js/jquery.tmpl.min.js"></script>
{% endblock %}

{% block content %}
<div class="row" id="loading_plugins_xml">
  <div class="span6">
    <img src="{% get_static_prefix %}common/img/loading_small.gif">
    Loading plugins.xml
  </div>
</div>

<div class="row">
  <div class="span6">
    <form class="form-inline" onsubmit="return false;">
      <fieldset>
        <legend>Update an app page from plugins.xml</legend>
        <input type="text" data-provide="typeahead" autocomplete="off" id="plugin-name" placeholder="Enter a 2.x plugin name" disabled>
        <button id="check-btn" class="btn disabled">Check</button>
      </fieldset>
    </form>
  </div>
</div>

<div class="row">
  <div class="span12" id="app-info">
  </div>
</div>

<script type="text/html" id="new-app-tmpl">
  <table class="table table-bordered">
    <tbody>
      <tr>
        <td><strong>New app page?</strong></td>
        <td>Yes</td>
      </tr>
      <tr>
        <td><strong>App name</strong></td>
        <td>${ fullname }</td>
      </tr>
    </tbody>
  </table>
</script>

<script type="text/html" id="existing-app-tmpl">
  <table class="table table-bordered">
    <tbody>
      <tr>
        <td><strong>New app page?</strong></td>
        <td>No</td>
      </tr>
      <tr>
        <td><strong>App name</strong></td>
        <td>${ fullname }</td>
      </tr>
      <tr>
        <td><strong>2.x plugin download</strong></td>
        <td><a href="${ cy2x_plugin_download }">${ cy2x_plugin_download }</a></td>
      </tr>
      <tr>
        <td><strong>2.x plugin version</strong></td>
        <td>${ cy2x_plugin_version }</td>
      </tr>
      <tr>
        <td><strong>Release date</strong></td>
        <td>${ release_date.getUTCFullYear() }-${ release_date.getUTCMonth() + 1 }-${ release_date.getUTCDate() }</td>
      </tr>
    </tbody>
  </table>
</script>

<script type="text/javascript">
  function parse_iso_date(str) {
    var d = new Date(str);
    if (isNaN(d.getTime())) {
      return null;
    } else {
      return d;
    }
  }

  function clean_str(str) {
    var trimmed = str.trim();
    if (trimmed.length === 0) {
      return null;
    } else {
      return trimmed;
    }
  }

  function parse_authors(authorlist_dom) {
    var authors = [];
    authorlist_dom.children('author').each(function() {
      var author_dom = $(this);
      var author = [
        clean_str(author_dom.children('name').text()),
        clean_str(author_dom.children('institution').text())
      ];
      authors.push(author);
    })
    return authors;
  }

  function parse_cy_versions(cy_versions_dom) {
    var versions = [];
    cy_versions_dom.children('version').each(function() {
      var version = ($(this)).text();
      versions.push(version);
    });
    return versions;
  }

  /*
  function compare_versions(plugin_a, plugin_b) {
    var result = compare_versions_x(plugin_a, plugin_b);
    var s;
    if (result === 1) {
      s = '>';
    } else if (result === -1) {
      s = '<';
    } else {
      s = '=';
    }
    return result;
  }
  */

  function compare_versions(plugin_a, plugin_b) {
    var a_pieces = plugin_a.cy2x_plugin_version.split('.');
    var b_pieces = plugin_b.cy2x_plugin_version.split('.');
    var a_len = a_pieces.length;
    var b_len = b_pieces.length;
    for (var i = 0; i < Math.min(a_len, b_len); i++) {
      var a_ver = parseInt(a_pieces[i], 10);
      var b_ver = parseInt(b_pieces[i], 10);
      var a_ok = !isNaN(a_ver);
      var b_ok = !isNaN(a_ver);
      if (a_ok && b_ok) {
        if (a_ver > b_ver) {
          return 1;
        } else if (a_ver < b_ver) {
          return -1;
        }
      } else if (a_ok && !b_ok) {
        return 1;
      } else if (!a_ok && b_ok) {
        return -1;
      }
    }
    if (a_len > b_len) {
      return 1;
    } else if (a_len === b_len) {
      return 0;
    } else {
      return -1;
    }
  }

  function parse_plugins_dom(plugins_dom) {
    var plugins = {};
    plugins_dom.find("project > pluginlist > plugin").each(function() {
      var plugin_dom = $(this);
      var fullname = plugin_dom.children('name').text();
      var plugin = {
        'fullname':             fullname,
        'authors':              parse_authors(plugin_dom.children('authorlist')),
        'details':              plugin_dom.children('description').text(),
        'cy2x_plugin_version':  plugin_dom.children('pluginVersion').text(),
        'cy2x_plugin_download': plugin_dom.children('url').text(),
        'cy_versions':          parse_cy_versions(plugin_dom.children('cytoscapeVersions')),
        'release_date':         parse_iso_date(plugin_dom.children('release_date').text()),
      }
      var other_plugin = plugins[fullname];
      if ((other_plugin === undefined) || (compare_versions(plugin, other_plugin) > 0)) {
        plugins[fullname] = plugin;
      }
    });
    return plugins;
  }

  function update_page_with_plugins_dom(plugins_dom) {
    var plugins = parse_plugins_dom(plugins_dom);
    var plugin_names = Object.keys(plugins);
    $('#loading_plugins_xml').hide();
    $('#plugin-name').removeAttr('disabled');
    $('#check-btn').removeClass('disabled');
    $('#plugin-name').typeahead({'source': plugin_names});
    $('#check-btn').click(function() {
      var fullname = $('#plugin-name').val();
      if (!(fullname in plugins)) {
        CyMsgs.add_msg('No such plugin \"' + fullname + '\".', 'error', 'invalid_plugin_name');
        return;
      }
      var plugin = plugins[fullname];
      $.post('', {'action': 'app_exists', 'app_name': fullname}, function(exists) {
        var tmpl = exists ? $('#existing-app-tmpl') : $('#new-app-tmpl') ;
        $('#app-info').empty().append(tmpl.tmpl(plugin));
      });
    });
  }

  $(function() {
    $.post('', {'action': 'plugins_xml'}, function(data) {
      update_page_with_plugins_dom($(data));
    }).fail(function() {
      CyMsgs.add_msg('Could not load plugins.xml', 'error');
      $('#loading_plugins_xml').hide();
    });
  });
</script>
{% endblock %}
